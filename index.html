<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none, orientation=landscape">
<title>Brawl Stars JS Edition</title>
<style>
    body { margin:0; overflow:hidden; background:#000; font-family: 'Arial', sans-serif; touch-action:none; user-select:none; }
    canvas { display:block; }
    
    /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–≤–æ—Ä–æ—Ç–µ —ç–∫—Ä–∞–Ω–∞ */
    @media screen and (orientation: portrait) {
        #rotate-notice { display: flex; }
    }
    #rotate-notice {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: #1a1a1a; color: white; z-index: 1000;
        align-items: center; justify-content: center; text-align: center;
    }

    #ui-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
    
    /* –°—Ç–∏–ª–∏ –º–µ–Ω—é */
    #menu, #matchmaking, #end-screen {
        position:absolute; top:0; left:0; width:100%; height:100%;
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        background:radial-gradient(circle,#1e3799,#000); color:white; z-index:500; pointer-events: all;
    }
    
    .hero-box { display:flex; gap:15px; }
    .card { 
        width:120px; padding:15px; background:#2f3542; border:4px solid #57606f; 
        border-radius:15px; cursor:pointer; text-align: center; transition: 0.2s;
    }
    .card:hover { transform: scale(1.1); border-color: #f1c40f; }

    /* HUD */
    #hud { position:absolute; top:20px; left:20px; color:white; font-size:20px; text-shadow:2px 2px #000; }

    /* –î–∂–æ–π—Å—Ç–∏–∫–∏ */
    .joystick-base {
        position: absolute; width: 130px; height: 130px;
        background: rgba(255,255,255,0.1); border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.2); pointer-events: all;
    }
    .joystick-stick {
        position: absolute; top: 35px; left: 35px; width: 60px; height: 60px;
        background: rgba(255,255,255,0.4); border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    #joy-move { bottom: 40px; left: 40px; }
    #joy-atk { bottom: 40px; right: 160px; border-color: rgba(235, 77, 75, 0.5); }
    #joy-ult { bottom: 60px; right: 40px; width: 100px; height: 100px; border-color: #f1c40f; }
    #joy-ult .joystick-stick { width: 40px; height: 40px; top: 30px; left: 30px; background: rgba(241, 196, 15, 0.6); }

    #ult-progress {
        position: absolute; width: 100%; height: 100%; border-radius: 50%;
        border: 4px solid transparent; border-top-color: #f1c40f;
        transform: rotate(-45deg); display: none;
    }
</style>
</head>
<body>

<div id="rotate-notice"><h1>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º</h1></div>

<div id="menu">
    <h1>BRAWL STARS JS</h1>
    <div class="hero-box" id="hero-list"></div>
</div>

<div id="matchmaking" style="display:none">
    <h2>–ü–û–ò–°–ö –ò–ì–†–û–ö–û–í...</h2>
    <h1 id="mm-count">0 / 10</h1>
</div>

<div id="end-screen" style="display:none">
    <h1 id="end-msg"></h1>
    <button style="padding:15px 40px; font-size:24px;" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
</div>

<div id="ui-layer">
    <div id="hud">üèÜ <span id="cur-trophies">0</span></div>
    
    <div id="joy-move" class="joystick-base"><div class="joystick-stick"></div></div>
    
    <div id="joy-atk" class="joystick-base"><div class="joystick-stick"></div></div>
    
    <div id="joy-ult" class="joystick-base">
        <div id="ult-progress"></div>
        <div class="joystick-stick"></div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const HEROES = {
    "–®–µ–ª–ª–∏": { hp: 3800, speed: 2.5, dmg: 400, reload: 1500, color: "#9b59b6", range: 400, ultType: "wide-blast" },
    "–ö–æ–ª—å—Ç": { hp: 2800, speed: 2.8, dmg: 350, reload: 1100, color: "#e74c3c", range: 700, ultType: "long-burst" },
    "–≠–ª—å –ü—Ä–∏–º–æ": { hp: 6000, speed: 2.3, dmg: 500, reload: 1000, color: "#e67e22", range: 180, ultType: "jump" }
};

let worldW = 3000, worldH = 2000;
let player, enemies = [], projectiles = [], cubes = [], walls = [];
let trophies = JSON.parse(localStorage.getItem("brawl_trophies")) || { "–®–µ–ª–ª–∏":0, "–ö–æ–ª—å—Ç":0, "–≠–ª—å –ü—Ä–∏–º–æ":0 };
let selectedHero = "–®–µ–ª–ª–∏";
let isRunning = false;

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∂–æ–π—Å—Ç–∏–∫–æ–≤
const input = {
    move: { active: false, x: 0, y: 0, dx: 0, dy: 0 },
    atk: { active: false, x: 0, y: 0, dx: 0, dy: 0, angle: 0 },
    ult: { active: false, x: 0, y: 0, dx: 0, dy: 0, angle: 0, ready: false, charge: 0 }
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

/* --- –£–ü–†–ê–í–õ–ï–ù–ò–ï --- */
function setupJoystick(id, type) {
    const el = document.getElementById(id);
    const stick = el.querySelector('.joystick-stick');
    
    el.addEventListener('touchstart', (e) => {
        const t = e.touches[0];
        const rect = el.getBoundingClientRect();
        input[type].active = true;
        input[type].x = rect.left + rect.width/2;
        input[type].y = rect.top + rect.height/2;
        e.preventDefault();
    }, {passive: false});

    window.addEventListener('touchmove', (e) => {
        if (!input[type].active) return;
        let touch = Array.from(e.touches).find(t => {
            let d = Math.hypot(t.clientX - input[type].x, t.clientY - input[type].y);
            return d < 200;
        });
        if (!touch) return;

        let dx = touch.clientX - input[type].x;
        let dy = touch.clientY - input[type].y;
        let dist = Math.hypot(dx, dy);
        let max = rect = el.offsetWidth / 2;

        if (dist > max) { dx *= max/dist; dy *= max/dist; }
        
        stick.style.transform = `translate(${dx}px, ${dy}px)`;
        input[type].dx = dx / max;
        input[type].dy = dy / max;
        input[type].angle = Math.atan2(dy, dx);
    });

    window.addEventListener('touchend', (e) => {
        if (!input[type].active) return;
        
        // –°—Ç—Ä–µ–ª—å–±–∞ –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏
        if (type === 'atk' && Math.hypot(input.atk.dx, input.atk.dy) > 0.3) {
            fire(player, input.atk.angle, false);
        } else if (type === 'ult' && input.ult.ready && Math.hypot(input.ult.dx, input.ult.dy) > 0.3) {
            fire(player, input.ult.angle, true);
            input.ult.charge = 0;
            input.ult.ready = false;
        }

        input[type].active = false;
        input[type].dx = 0; input[type].dy = 0;
        stick.style.transform = `translate(0,0)`;
    });
}

setupJoystick('joy-move', 'move');
setupJoystick('joy-atk', 'atk');
setupJoystick('joy-ult', 'ult');

/* --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ --- */
function startMM(name) {
    selectedHero = name;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('matchmaking').style.display = 'flex';
    let c = 0;
    let inter = setInterval(() => {
        c += Math.floor(Math.random()*3);
        if(c >= 10) { 
            c=10; clearInterval(inter); 
            setTimeout(() => {
                document.getElementById('matchmaking').style.display = 'none';
                initGame();
            }, 500);
        }
        document.getElementById('mm-count').innerText = c + " / 10";
    }, 200);
}

function initGame() {
    player = {
        ...HEROES[selectedHero],
        x: worldW/2, y: worldH/2,
        hp: HEROES[selectedHero].hp, maxHp: HEROES[selectedHero].hp,
        ammo: 3, lastReload: Date.now(),
        cubes: 0, id: 'player'
    };
    
    // –°–ø–∞–≤–Ω –±–æ—Ç–æ–≤
    enemies = [];
    const names = ["BrawlMaster", "Leon2014", "Pro_Killer", "Crow_God", "BullBoy", "PocoLoco", "Shelly", "Colt_S", "Primo_X"];
    for(let i=0; i<9; i++) {
        let hKey = Object.keys(HEROES)[Math.floor(Math.random()*3)];
        enemies.push({
            ...HEROES[hKey],
            nickname: names[i],
            x: Math.random()*worldW, y: Math.random()*worldH,
            hp: HEROES[hKey].hp, maxHp: HEROES[hKey].hp,
            cubes: 0, id: 'bot'+i, nextAtk: 0
        });
    }
    isRunning = true;
    requestAnimationFrame(loop);
}

function fire(ent, angle, isUlt) {
    if (!isUlt && ent.ammo < 1) return;
    if (!isUlt) {
        ent.ammo--;
        ent.lastReload = Date.now();
    }

    const speed = 15;
    if (ent.ultType === "wide-blast" && isUlt || ent.color === "#9b59b6" && !isUlt) {
        // –î—Ä–æ–±–æ–≤–∏–∫
        for(let i=-2; i<=2; i++) {
            projectiles.push({
                x: ent.x, y: ent.y, 
                vx: Math.cos(angle + i*0.2) * speed, vy: Math.sin(angle + i*0.2) * speed,
                dmg: ent.dmg, owner: ent.id, range: isUlt ? 500 : 350, dist: 0
            });
        }
    } else {
        // –ü—É–ª–∏
        projectiles.push({
            x: ent.x, y: ent.y, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed,
            dmg: ent.dmg, owner: ent.id, range: ent.range, dist: 0
        });
    }
}

function update() {
    if (!isRunning) return;

    // –î–≤–∏–∂–µ–Ω–∏–µ
    player.x += input.move.dx * player.speed;
    player.y += input.move.dy * player.speed;

    // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ç—Ä–æ–Ω–æ–≤
    if (player.ammo < 3 && Date.now() - player.lastReload > player.reload) {
        player.ammo++;
        player.lastReload = Date.now();
    }

    // –£–ª—å—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å
    const ultEl = document.getElementById('ult-progress');
    if (input.ult.charge >= 100) {
        input.ult.ready = true;
        ultEl.style.display = 'block';
    } else {
        ultEl.style.display = 'none';
    }

    // –ü—É–ª–∏
    projectiles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.dist += Math.hypot(p.vx, p.vy);
        if (p.dist > p.range) projectiles.splice(i, 1);

        // –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤–æ –≤—Ä–∞–≥–æ–≤
        if (p.owner === 'player') {
            enemies.forEach(en => {
                if (Math.hypot(p.x - en.x, p.y - en.y) < 30) {
                    en.hp -= p.dmg;
                    input.ult.charge = Math.min(100, input.ult.charge + 5);
                    projectiles.splice(i, 1);
                }
            });
        } else {
            if (Math.hypot(p.x - player.x, p.y - player.y) < 30) {
                player.hp -= p.dmg;
                projectiles.splice(i, 1);
            }
        }
    });

    enemies.forEach((en, i) => {
        if (en.hp <= 0) {
            cubes.push({x: en.x, y: en.y});
            enemies.splice(i, 1);
        }
        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—Ç–æ–≤
        let d = Math.hypot(player.x - en.x, player.y - en.y);
        if (d < 400 && Date.now() > en.nextAtk) {
            fire(en, Math.atan2(player.y - en.y, player.x - en.x), false);
            en.nextAtk = Date.now() + en.reload;
        }
    });

    cubes.forEach((c, i) => {
        if (Math.hypot(player.x - c.x, player.y - c.y) < 40) {
            player.cubes++;
            player.hp = Math.min(player.maxHp, player.hp + 500);
            cubes.splice(i, 1);
        }
    });

    if (player.hp <= 0) { isRunning = false; showEnd(false); }
    if (enemies.length === 0) { isRunning = false; showEnd(true); }
}

function draw() {
    ctx.fillStyle = "#2d5a27";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-player.x + canvas.width/2, -player.y + canvas.height/2);

    // –°–µ—Ç–∫–∞ –∑–µ–º–ª–∏
    ctx.strokeStyle = "rgba(0,0,0,0.1)";
    for(let i=0; i<worldW; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, worldH); ctx.stroke(); }
    for(let i=0; i<worldH; i+=100) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(worldW, i); ctx.stroke(); }

    // –ë–∞–Ω–∫–∏
    cubes.forEach(c => {
        ctx.fillStyle = "#f1c40f";
        ctx.fillRect(c.x-10, c.y-10, 20, 20);
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    const drawChar = (char, isPlayer) => {
        ctx.fillStyle = char.color;
        ctx.beginPath(); ctx.arc(char.x, char.y, 30, 0, Math.PI*2); ctx.fill();
        
        // HP Bar
        const barW = 80;
        ctx.fillStyle = "#000"; ctx.fillRect(char.x - barW/2, char.y - 60, barW, 12);
        ctx.fillStyle = isPlayer ? "#2ecc71" : "#e74c3c";
        ctx.fillRect(char.x - barW/2 + 2, char.y - 58, (char.hp/char.maxHp)*(barW-4), 8);
        
        // HP Text
        ctx.fillStyle = "#fff"; ctx.font = "bold 10px Arial"; ctx.textAlign = "center";
        ctx.fillText(Math.ceil(char.hp), char.x, char.y - 50);

        // –ù–∏–∫ –∏ –±–∞–Ω–∫–∏
        ctx.font = "14px Arial";
        ctx.fillText((isPlayer ? "–í—ã" : char.nickname) + " [" + char.cubes + "]", char.x, char.y - 70);

        // –ü–∞—Ç—Ä–æ–Ω—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∏–≥—Ä–æ–∫–∞)
        if (isPlayer) {
            for(let i=0; i<3; i++) {
                ctx.fillStyle = char.ammo > i ? "#e67e22" : "#555";
                ctx.fillRect(char.x - barW/2 + (i*28), char.y - 45, 24, 4);
            }
        }
    };

    enemies.forEach(en => drawChar(en, false));
    drawChar(player, true);

    // –ü—Ä–∏—Ü–µ–ª
    if (input.atk.active && Math.hypot(input.atk.dx, input.atk.dy) > 0.2) {
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.setLineDash([10, 10]);
        ctx.beginPath();
        ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x + Math.cos(input.atk.angle)*player.range, player.y + Math.sin(input.atk.angle)*player.range);
        ctx.stroke();
        ctx.setLineDash([]);
    }
    
    // –ü—Ä–∏—Ü–µ–ª –£–ª—å—Ç—ã
    if (input.ult.active && input.ult.ready) {
        ctx.strokeStyle = "#f1c40f";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x + Math.cos(input.ult.angle)*600, player.y + Math.sin(input.ult.angle)*600);
        ctx.stroke();
    }

    // –ü—É–ª–∏
    projectiles.forEach(p => {
        ctx.fillStyle = "yellow";
        ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
    });

    ctx.restore();
}

function loop() {
    update();
    draw();
    if(isRunning) requestAnimationFrame(loop);
}

function showEnd(win) {
    document.getElementById('end-screen').style.display = 'flex';
    document.getElementById('end-msg').innerText = win ? "–ü–û–ë–ï–î–ê!" : "–ü–û–†–ê–ñ–ï–ù–ò–ï";
    if(win) trophies[selectedHero]+=8;
    localStorage.setItem("brawl_trophies", JSON.stringify(trophies));
}

// –†–µ–Ω–¥–µ—Ä –≤—ã–±–æ—Ä–∞ –≥–µ—Ä–æ–µ–≤
const hList = document.getElementById('hero-list');
Object.keys(HEROES).forEach(h => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<h3>${h}</h3><p>üèÜ ${trophies[h]}</p>`;
    card.onclick = () => startMM(h);
    hList.appendChild(card);
});

</script>
</body>
</html>
