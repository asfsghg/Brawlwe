<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=none">
<title>Brawl Stars JS - Fixed First Match</title>
<style>
    body { margin:0; overflow:hidden; background:#1a1a1a; font-family:sans-serif; touch-action:none; user-select:none; }
    canvas { display:block; background:#2d5a27; }
    
    #menu, #end-screen {
        position:absolute; top:0; left:0; width:100%; height:100%;
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        background:radial-gradient(circle,#1e3799,#000); color:white; z-index:1000;
    }
    #end-screen { display:none; }

    /* –î–∂–æ–π—Å—Ç–∏–∫–∏ */
    .joy-container {
        position: absolute; width: 140px; height: 140px;
        background: rgba(255,255,255,0.1); border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.2); pointer-events: all;
    }
    .stick {
        position: absolute; top: 40px; left: 40px; width: 60px; height: 60px;
        background: rgba(255,255,255,0.4); border-radius: 50%;
    }
    
    #move-container { bottom: 40px; left: 40px; }
    #atk-container { bottom: 40px; right: 180px; border-color: rgba(235,77,75,0.5); }
    #ult-container { bottom: 60px; right: 40px; width: 100px; height: 100px; border-color: #f1c40f; opacity: 0.4; }

    #hud { position:absolute; top:10px; left:10px; color:white; font-size:18px; text-shadow:2px 2px #000; pointer-events:none; }
    .hero-btn { padding:15px; background:#2f3542; color:white; border:2px solid #fff; border-radius:10px; cursor:pointer; margin:5px; }
</style>
</head>
<body>

<div id="menu">
    <h1>BRAWL STARS JS</h1>
    <div id="hero-list"></div>
</div>

<div id="end-screen">
    <h1 id="result-msg"></h1>
    <button class="hero-btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
</div>

<div id="hud">
    üèÜ <span id="trophies-val">0</span> | üîã –£–ª—å—Ç–∞: <span id="ult-val">0</span>%
</div>

<div id="move-container" class="joy-container"><div class="stick" id="move-stick"></div></div>
<div id="atk-container" class="joy-container"><div class="stick" id="atk-stick"></div></div>
<div id="ult-container" class="joy-container"><div class="stick" id="ult-stick"></div></div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let w = window.innerWidth, h = window.innerHeight;
canvas.width = w; canvas.height = h;

const HEROES = {
    "–®–µ–ª–ª–∏": { hp: 3800, speed: 2.8, dmg: 400, reload: 1200, color: "#9b59b6", range: 450, ultReady: false },
    "–ö–æ–ª—å—Ç": { hp: 2800, speed: 3.2, dmg: 350, reload: 900, color: "#e74c3c", range: 700, ultReady: false },
    "–≠–ª—å –ü—Ä–∏–º–æ": { hp: 6000, speed: 2.4, dmg: 450, reload: 800, color: "#e67e22", range: 220, ultReady: false }
};

let trophies = JSON.parse(localStorage.getItem("brawl_t_v3")) || { "–®–µ–ª–ª–∏":0, "–ö–æ–ª—å—Ç":0, "–≠–ª—å –ü—Ä–∏–º–æ":0 };
let player, enemies = [], projectiles = [], cubes = [], isPlaying = false;
let ultCharge = 0;

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
const input = {
    move: { active: false, x: 0, y: 0, dx: 0, dy: 0 },
    atk: { active: false, x: 0, y: 0, dx: 0, dy: 0, angle: 0 },
    ult: { active: false, x: 0, y: 0, dx: 0, dy: 0, angle: 0 }
};

function initJoy(id, type) {
    const el = document.getElementById(id + '-container');
    const stick = document.getElementById(id + '-stick');
    
    el.addEventListener('touchstart', e => {
        const t = e.touches[0];
        const rect = el.getBoundingClientRect();
        input[type].active = true;
        input[type].originX = rect.left + rect.width/2;
        input[type].originY = rect.top + rect.height/2;
    });

    window.addEventListener('touchmove', e => {
        if (!input[type].active) return;
        const t = Array.from(e.touches).find(touch => {
            const rect = el.getBoundingClientRect();
            return Math.hypot(touch.clientX - (rect.left+rect.width/2), touch.clientY - (rect.top+rect.height/2)) < 200;
        });
        if (!t) return;

        let dx = t.clientX - input[type].originX;
        let dy = t.clientY - input[type].originY;
        const dist = Math.hypot(dx, dy);
        const max = 50;

        if (dist > max) { dx *= max/dist; dy *= max/dist; }
        stick.style.transform = `translate(${dx}px, ${dy}px)`;
        
        input[type].dx = dx/max;
        input[type].dy = dy/max;
        input[type].angle = Math.atan2(dy, dx);
    });

    window.addEventListener('touchend', () => {
        if (!input[type].active) return;
        if (type === 'atk' && Math.hypot(input.atk.dx, input.atk.dy) > 0.3) fire(player, input.atk.angle, false);
        if (type === 'ult' && ultCharge >= 100 && Math.hypot(input.ult.dx, input.ult.dy) > 0.3) fire(player, input.ult.angle, true);
        
        input[type].active = false;
        input[type].dx = 0; input[type].dy = 0;
        stick.style.transform = `translate(0,0)`;
    });
}

initJoy('move', 'move');
initJoy('atk', 'atk');
initJoy('ult', 'ult');

function spawnMatch(heroName) {
    player = { ...HEROES[heroName], name: heroName, x: 1500, y: 1500, maxHp: HEROES[heroName].hp, ammo: 3, lastAtk: 0, cubes: 0, id: 'p' };
    enemies = []; projectiles = []; cubes = []; ultCharge = 0;
    
    for(let i=0; i<9; i++) {
        const h = Object.keys(HEROES)[Math.floor(Math.random()*3)];
        enemies.push({ ...HEROES[h], nickname: "Bot_"+i, x: Math.random()*2800+100, y: Math.random()*2800+100, maxHp: HEROES[h].hp, ammo: 3, lastAtk: 0, cubes: 0, id: 'b'+i });
    }
    
    document.getElementById('menu').style.display = 'none';
    document.getElementById('trophies-val').innerText = trophies[heroName];
    isPlaying = true;
    requestAnimationFrame(gameLoop);
}

function fire(ent, angle, isUlt) {
    if (!isUlt && ent.ammo < 1) return;
    if (!isUlt) { ent.ammo--; ent.lastAtk = Date.now(); }
    else { ultCharge = 0; }

    const count = (isUlt && ent.name === "–®–µ–ª–ª–∏") ? 10 : 1;
    for(let i=0; i<count; i++) {
        projectiles.push({
            x: ent.x, y: ent.y, 
            vx: Math.cos(angle + (i-count/2)*0.1) * 15, 
            vy: Math.sin(angle + (i-count/2)*0.1) * 15,
            dmg: ent.dmg, range: isUlt ? ent.range*1.5 : ent.range, dist: 0, owner: ent.id
        });
    }
}

function update() {
    if (!isPlaying) return;

    // –î–≤–∏–∂–µ–Ω–∏–µ
    player.x += input.move.dx * player.speed;
    player.y += input.move.dy * player.speed;

    // –†–µ–≥–µ–Ω –ø–∞—Ç—Ä–æ–Ω–æ–≤
    if (player.ammo < 3 && Date.now() - player.lastAtk > player.reload) {
        player.ammo++;
        player.lastAtk = Date.now();
    }

    // –£–ª—å—Ç–∞ UI
    document.getElementById('ult-val').innerText = Math.floor(ultCharge);
    document.getElementById('ult-container').style.opacity = ultCharge >= 100 ? "1" : "0.4";

    projectiles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.dist += 15;
        if (p.dist > p.range) projectiles.splice(i, 1);

        const targets = p.owner === 'p' ? enemies : [player];
        targets.forEach(t => {
            if (Math.hypot(p.x - t.x, p.y - t.y) < 30) {
                t.hp -= p.dmg;
                if (p.owner === 'p') ultCharge = Math.min(100, ultCharge + 8);
                projectiles.splice(i, 1);
            }
        });
    });

    enemies.forEach((en, i) => {
        if (en.hp <= 0) { cubes.push({x:en.x, y:en.y}); enemies.splice(i, 1); }
        let d = Math.hypot(player.x - en.x, player.y - en.y);
        if (d < en.range && Date.now() - en.lastAtk > en.reload) {
            fire(en, Math.atan2(player.y - en.y, player.x - en.x), false);
        }
    });

    cubes.forEach((c, i) => {
        if (Math.hypot(player.x - c.x, player.y - c.y) < 40) {
            player.cubes++; player.hp += 400; cubes.splice(i, 1);
        }
    });

    if (player.hp <= 0) endGame(false);
    if (enemies.length === 0) endGame(true);
}

function draw() {
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.translate(-player.x + w/2, -player.y + h/2);

    // –ò–≥—Ä–æ–∫ –∏ –≤—Ä–∞–≥–∏
    const drawEntity = (e, isP) => {
        ctx.fillStyle = e.color;
        ctx.beginPath(); ctx.arc(e.x, e.y, 30, 0, Math.PI*2); ctx.fill();
        
        // HP Bar
        ctx.fillStyle = "#000"; ctx.fillRect(e.x-40, e.y-55, 80, 10);
        ctx.fillStyle = isP ? "#2ecc71" : "#e74c3c";
        ctx.fillRect(e.x-38, e.y-53, (e.hp/e.maxHp)*76, 6);
        
        // Ammo (—Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫—É)
        if(isP) {
            for(let i=0; i<3; i++) {
                ctx.fillStyle = e.ammo > i ? "#e67e22" : "#555";
                ctx.fillRect(e.x-38 + i*26, e.y-42, 22, 4);
            }
        }
    };

    drawEntity(player, true);
    enemies.forEach(en => drawEntity(en, false));
    
    // –ü—Ä–∏—Ü–µ–ª—ã
    if (input.atk.active) {
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.beginPath(); ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x + Math.cos(input.atk.angle)*player.range, player.y + Math.sin(input.atk.angle)*player.range);
        ctx.stroke();
    }
    if (input.ult.active && ultCharge >= 100) {
        ctx.strokeStyle = "#f1c40f"; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x + Math.cos(input.ult.angle)*player.range*1.5, player.y + Math.sin(input.ult.angle)*player.range*1.5);
        ctx.stroke(); ctx.lineWidth = 1;
    }

    ctx.fillStyle = "yellow";
    projectiles.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill(); });
    ctx.restore();
}

function endGame(win) {
    isPlaying = false;
    if (win) trophies[player.name] += 8; else trophies[player.name] = Math.max(0, trophies[player.name]-4);
    localStorage.setItem("brawl_t_v3", JSON.stringify(trophies));
    document.getElementById('end-screen').style.display = 'flex';
    document.getElementById('result-msg').innerText = win ? "–ü–û–ë–ï–î–ê +8 üèÜ" : "–ü–û–†–ê–ñ–ï–ù–ò–ï -4 üèÜ";
}

function gameLoop() { update(); draw(); if(isPlaying) requestAnimationFrame(gameLoop); }

Object.keys(HEROES).forEach(h => {
    const btn = document.createElement('button');
    btn.className = 'hero-btn';
    btn.innerHTML = `${h}<br>üèÜ ${trophies[h]}`;
    btn.onclick = () => spawnMatch(h);
    document.getElementById('hero-list').appendChild(btn);
});
</script>
</body>
</html>

